{"version":3,"sources":["../../../src/path-layer/path-layer.js"],"names":["fp64LowPart","fp64","DEFAULT_COLOR","defaultProps","widthScale","widthMinPixels","widthMaxPixels","Number","MAX_SAFE_INTEGER","rounded","miterLimit","dashJustified","getPath","object","path","getColor","getWidth","getDashArray","isClosed","firstPoint","lastPoint","length","ATTRIBUTE_TRANSITION","enter","value","chunk","subarray","PathLayer","use64bitProjection","vs","vs64","fs","modules","attributeManager","getAttributeManager","addInstanced","instanceStartPositions","size","transition","accessor","update","calculateStartPositions","instanceEndPositions","calculateEndPositions","instanceLeftDeltas","calculateLeftDeltas","instanceRightDeltas","calculateRightDeltas","instanceStrokeWidths","calculateStrokeWidths","defaultValue","instanceDashArrays","calculateDashArrays","instanceColors","type","GL","UNSIGNED_BYTE","calculateColors","instancePickingColors","calculatePickingColors","props","oldProps","changeFlags","invalidateAll","coordinateSystem","COORDINATE_SYSTEM","LNGLAT","instanceStartEndPositions64xyLow","calculateInstanceStartEndPositions64xyLow","remove","gl","context","state","model","delete","setState","_getModel","updateAttribute","geometryChanged","dataChanged","updateTriggersChanged","all","paths","data","map","bufferLayout","numInstances","reduce","count","segments","uniforms","render","Object","assign","jointType","alignMode","SEGMENT_INDICES","SEGMENT_POSITIONS","Model","getShaders","id","geometry","Geometry","drawMode","TRIANGLES","attributes","indices","Uint16Array","positions","Float32Array","isInstanced","shaderCache","attribute","i","forEach","numSegments","ptIndex","point","startPoint","endPoint","prevPoint","nextPoint","index","width","pathLength","_getPathLength","dashArray","pointColor","isNaN","pickingColor","encodePickingColor","Layer","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {COORDINATE_SYSTEM, Layer} from '@deck.gl/core';\nimport GL from 'luma.gl/constants';\nimport {Model, Geometry, fp64} from 'luma.gl';\nconst {fp64LowPart} = fp64;\n\nimport vs from './path-layer-vertex.glsl';\nimport vs64 from './path-layer-vertex-64.glsl';\nimport fs from './path-layer-fragment.glsl';\n\nconst DEFAULT_COLOR = [0, 0, 0, 255];\n\nconst defaultProps = {\n  widthScale: 1, // stroke width in meters\n  widthMinPixels: 0, //  min stroke width in pixels\n  widthMaxPixels: Number.MAX_SAFE_INTEGER, // max stroke width in pixels\n  rounded: false,\n  miterLimit: 4,\n  fp64: false,\n  dashJustified: false,\n\n  getPath: object => object.path,\n  getColor: DEFAULT_COLOR,\n  getWidth: 1,\n  getDashArray: null\n};\n\nconst isClosed = path => {\n  const firstPoint = path[0];\n  const lastPoint = path[path.length - 1];\n  return (\n    firstPoint[0] === lastPoint[0] &&\n    firstPoint[1] === lastPoint[1] &&\n    firstPoint[2] === lastPoint[2]\n  );\n};\n\nconst ATTRIBUTE_TRANSITION = {\n  enter: (value, chunk) => {\n    return chunk.length ? chunk.subarray(chunk.length - value.length) : value;\n  }\n};\n\nexport default class PathLayer extends Layer {\n  getShaders() {\n    return this.use64bitProjection()\n      ? {vs: vs64, fs, modules: ['project64', 'picking']}\n      : {vs, fs, modules: ['picking']}; // 'project' module added by default.\n  }\n\n  initializeState() {\n    const attributeManager = this.getAttributeManager();\n    /* eslint-disable max-len */\n    attributeManager.addInstanced({\n      instanceStartPositions: {\n        size: 3,\n        transition: ATTRIBUTE_TRANSITION,\n        accessor: 'getPath',\n        update: this.calculateStartPositions\n      },\n      instanceEndPositions: {\n        size: 3,\n        transition: ATTRIBUTE_TRANSITION,\n        accessor: 'getPath',\n        update: this.calculateEndPositions\n      },\n      instanceLeftDeltas: {size: 3, update: this.calculateLeftDeltas},\n      instanceRightDeltas: {size: 3, update: this.calculateRightDeltas},\n      instanceStrokeWidths: {\n        size: 1,\n        accessor: 'getWidth',\n        transition: ATTRIBUTE_TRANSITION,\n        update: this.calculateStrokeWidths,\n        defaultValue: 1\n      },\n      instanceDashArrays: {size: 2, accessor: 'getDashArray', update: this.calculateDashArrays},\n      instanceColors: {\n        size: 4,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getColor',\n        transition: ATTRIBUTE_TRANSITION,\n        update: this.calculateColors,\n        defaultValue: DEFAULT_COLOR\n      },\n      instancePickingColors: {size: 3, type: GL.UNSIGNED_BYTE, update: this.calculatePickingColors}\n    });\n    /* eslint-enable max-len */\n  }\n\n  updateAttribute({props, oldProps, changeFlags}) {\n    if (props.fp64 !== oldProps.fp64) {\n      const attributeManager = this.getAttributeManager();\n      attributeManager.invalidateAll();\n\n      if (props.fp64 && props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT) {\n        attributeManager.addInstanced({\n          instanceStartEndPositions64xyLow: {\n            size: 4,\n            update: this.calculateInstanceStartEndPositions64xyLow\n          }\n        });\n      } else {\n        attributeManager.remove(['instanceStartEndPositions64xyLow']);\n      }\n    }\n  }\n\n  updateState({oldProps, props, changeFlags}) {\n    super.updateState({props, oldProps, changeFlags});\n\n    const {getPath} = this.props;\n    const attributeManager = this.getAttributeManager();\n    if (props.fp64 !== oldProps.fp64) {\n      const {gl} = this.context;\n      if (this.state.model) {\n        this.state.model.delete();\n      }\n      this.setState({model: this._getModel(gl)});\n    }\n    this.updateAttribute({props, oldProps, changeFlags});\n\n    const geometryChanged =\n      changeFlags.dataChanged ||\n      (changeFlags.updateTriggersChanged &&\n        (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getPath));\n\n    if (geometryChanged) {\n      // this.state.paths only stores point positions in each path\n      const paths = props.data.map(getPath);\n      const bufferLayout = paths.map(path => path.length - 1);\n      const numInstances = bufferLayout.reduce((count, segments) => count + segments, 0);\n\n      this.setState({\n        paths,\n        numInstances,\n        bufferLayout\n      });\n      attributeManager.invalidateAll();\n    }\n  }\n\n  draw({uniforms}) {\n    const {\n      rounded,\n      miterLimit,\n      widthScale,\n      widthMinPixels,\n      widthMaxPixels,\n      dashJustified\n    } = this.props;\n\n    this.state.model.render(\n      Object.assign({}, uniforms, {\n        jointType: Number(rounded),\n        alignMode: Number(dashJustified),\n        widthScale,\n        miterLimit,\n        widthMinPixels,\n        widthMaxPixels\n      })\n    );\n  }\n\n  _getModel(gl) {\n    /*\n     *       _\n     *        \"-_ 1                   3                       5\n     *     _     \"o---------------------o-------------------_-o\n     *       -   / \"\"--..__              '.             _.-' /\n     *   _     \"@- - - - - \"\"--..__- - - - x - - - -_.@'    /\n     *    \"-_  /                   \"\"--..__ '.  _,-` :     /\n     *       \"o----------------------------\"\"-o'    :     /\n     *      0,2                            4 / '.  :     /\n     *                                      /   '.:     /\n     *                                     /     :'.   /\n     *                                    /     :  ', /\n     *                                   /     :     o\n     */\n\n    const SEGMENT_INDICES = [\n      // start corner\n      0,\n      2,\n      1,\n      // body\n      1,\n      2,\n      4,\n      1,\n      4,\n      3,\n      // end corner\n      3,\n      4,\n      5\n    ];\n\n    // [0] position on segment - 0: start, 1: end\n    // [1] side of path - -1: left, 0: center, 1: right\n    // [2] role - 0: offset point 1: joint point\n    const SEGMENT_POSITIONS = [\n      // bevel start corner\n      0,\n      0,\n      1,\n      // start inner corner\n      0,\n      -1,\n      0,\n      // start outer corner\n      0,\n      1,\n      0,\n      // end inner corner\n      1,\n      -1,\n      0,\n      // end outer corner\n      1,\n      1,\n      0,\n      // bevel end corner\n      1,\n      0,\n      1\n    ];\n\n    return new Model(\n      gl,\n      Object.assign({}, this.getShaders(), {\n        id: this.props.id,\n        geometry: new Geometry({\n          drawMode: GL.TRIANGLES,\n          attributes: {\n            indices: new Uint16Array(SEGMENT_INDICES),\n            positions: new Float32Array(SEGMENT_POSITIONS)\n          }\n        }),\n        isInstanced: true,\n        shaderCache: this.context.shaderCache\n      })\n    );\n  }\n\n  // \"Experimental\" method indended to make it easier to support non-nested arrays in subclasses\n  _getPathLength(path) {\n    return path.length;\n  }\n\n  calculateStartPositions(attribute) {\n    const {paths, bufferLayout} = this.state;\n    const {value} = attribute;\n\n    attribute.bufferLayout = bufferLayout;\n\n    let i = 0;\n    paths.forEach(path => {\n      const numSegments = path.length - 1;\n      for (let ptIndex = 0; ptIndex < numSegments; ptIndex++) {\n        const point = path[ptIndex];\n        value[i++] = point[0];\n        value[i++] = point[1];\n        value[i++] = point[2] || 0;\n      }\n    });\n  }\n\n  calculateEndPositions(attribute) {\n    const {paths, bufferLayout} = this.state;\n    const {value} = attribute;\n\n    attribute.bufferLayout = bufferLayout;\n\n    let i = 0;\n    paths.forEach(path => {\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        const point = path[ptIndex];\n        value[i++] = point[0];\n        value[i++] = point[1];\n        value[i++] = point[2] || 0;\n      }\n    });\n  }\n\n  calculateInstanceStartEndPositions64xyLow(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      const numSegments = path.length - 1;\n      for (let ptIndex = 0; ptIndex < numSegments; ptIndex++) {\n        const startPoint = path[ptIndex];\n        const endPoint = path[ptIndex + 1];\n        value[i++] = fp64LowPart(startPoint[0]);\n        value[i++] = fp64LowPart(startPoint[1]);\n        value[i++] = fp64LowPart(endPoint[0]);\n        value[i++] = fp64LowPart(endPoint[1]);\n      }\n    });\n  }\n\n  calculateLeftDeltas(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      const numSegments = path.length - 1;\n      let prevPoint = isClosed(path) ? path[path.length - 2] : path[0];\n\n      for (let ptIndex = 0; ptIndex < numSegments; ptIndex++) {\n        const point = path[ptIndex];\n        value[i++] = point[0] - prevPoint[0];\n        value[i++] = point[1] - prevPoint[1];\n        value[i++] = point[2] - prevPoint[2] || 0;\n        prevPoint = point;\n      }\n    });\n  }\n\n  calculateRightDeltas(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        const point = path[ptIndex];\n        let nextPoint = path[ptIndex + 1];\n        if (!nextPoint) {\n          nextPoint = isClosed(path) ? path[1] : point;\n        }\n\n        value[i++] = nextPoint[0] - point[0];\n        value[i++] = nextPoint[1] - point[1];\n        value[i++] = nextPoint[2] - point[2] || 0;\n      }\n    });\n  }\n\n  calculateStrokeWidths(attribute) {\n    const {data, getWidth} = this.props;\n    const {paths, bufferLayout} = this.state;\n    const {value} = attribute;\n\n    attribute.bufferLayout = bufferLayout;\n\n    let i = 0;\n    paths.forEach((path, index) => {\n      const width = getWidth(data[index], index);\n\n      const pathLength = this._getPathLength(path);\n      for (let ptIndex = 1; ptIndex < pathLength; ptIndex++) {\n        value[i++] = width;\n      }\n    });\n  }\n\n  calculateDashArrays(attribute) {\n    const {data, getDashArray} = this.props;\n    if (!getDashArray) {\n      return;\n    }\n\n    const {paths} = this.state;\n    const {value} = attribute;\n    let i = 0;\n    paths.forEach((path, index) => {\n      const dashArray = getDashArray(data[index], index);\n\n      const pathLength = this._getPathLength(path);\n      for (let ptIndex = 1; ptIndex < pathLength; ptIndex++) {\n        value[i++] = dashArray[0];\n        value[i++] = dashArray[1];\n      }\n    });\n  }\n\n  calculateColors(attribute) {\n    const {data, getColor} = this.props;\n    const {paths, bufferLayout} = this.state;\n    const {value} = attribute;\n\n    attribute.bufferLayout = bufferLayout;\n\n    let i = 0;\n    paths.forEach((path, index) => {\n      const pointColor = getColor(data[index], index);\n      if (isNaN(pointColor[3])) {\n        pointColor[3] = 255;\n      }\n\n      const pathLength = this._getPathLength(path);\n      for (let ptIndex = 1; ptIndex < pathLength; ptIndex++) {\n        value[i++] = pointColor[0];\n        value[i++] = pointColor[1];\n        value[i++] = pointColor[2];\n        value[i++] = pointColor[3];\n      }\n    });\n  }\n\n  // Override the default picking colors calculation\n  calculatePickingColors(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach((path, index) => {\n      const pickingColor = this.encodePickingColor(index);\n\n      const pathLength = this._getPathLength(path);\n      for (let ptIndex = 1; ptIndex < pathLength; ptIndex++) {\n        value[i++] = pickingColor[0];\n        value[i++] = pickingColor[1];\n        value[i++] = pickingColor[2];\n      }\n    });\n  }\n}\n\nPathLayer.layerName = 'PathLayer';\nPathLayer.defaultProps = defaultProps;\n"],"file":"path-layer.js"}